name: Smoke test code samples (parallel)

on:
  schedule:
    - cron: "0 0 * * *"     # daily at 00:00 UTC
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      paths: ${{ steps.collect.outputs.paths }}
      count: ${{ steps.collect.outputs.count }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: collect
        run: |
          python - <<'PY'
          import json, os
          # Pretend we "discovered" two items
          values = ["x", "y", "z"]
          matrix = {"item": values}
          print("Discovered:", matrix)

          # Write to GitHub Actions output file
          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"items={json.dumps(matrix)}\n")
          PY



#    runs-on: ubuntu-latest
#    outputs:
#      items: ${{ steps.set-output.outputs.items }}
#    steps:
#      - id: set-output
#        run: |
#          echo 'items={"item":["x","y", "z"]}' >> $GITHUB_OUTPUT

  echo-item:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.discover.outputs.items) }}
    steps:
      - run: echo "Hello from ${{ matrix.item }}"

#      - name: Collect endpoints from spec (minus BROKEN)
#        id: collect
#        env:
#          API_URL: "https://spec.speakeasy.com/compasslabs/api/compass-api-with-code-samples"
#        run: |
#          python - <<'PY'
#import json, os, requests, sys
#API_URL = os.environ["API_URL"]