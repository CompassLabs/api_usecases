name: workflow 1

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      items: ${{ steps.collect.outputs.items }}   # <-- expose "items"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - id: collect
        run: python v1/test_sdk_snippets/discover_endpoints.py   # <-- run script
      - run: echo "items = ${{ steps.collect.outputs.items }}"

  echo-item:
    needs: discover
    # Only run if discover produced something JSON-ish
    if: ${{ needs.discover.outputs.items != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # Fallback to an empty matrix if items is blank (prevents fromJson('') errors)
      matrix: ${{ fromJson(needs.discover.outputs.items != '' && needs.discover.outputs.items || '{"item":[]}' ) }}
    steps:
      - run: python v1/test_sdk_snippets/test_endpoint_snippet.py
        env:
          ENDPOINT: ${{ matrix.item }}